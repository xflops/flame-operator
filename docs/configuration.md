# FlameCluster Configuration Reference

This document provides a complete reference for the FlameCluster Custom Resource Definition (CRD).

## Overview

The `FlameCluster` CRD is the primary API for deploying and managing Flame clusters. A single FlameCluster resource defines:

- Session Manager configuration and deployment
- Executor Manager configuration and scaling
- Object Cache settings
- Service discovery endpoints (auto-generated)

## API Version

```yaml
apiVersion: flame.xflops.io/v1alpha1
kind: FlameCluster
```

## Metadata

Standard Kubernetes metadata fields:

```yaml
metadata:
  name: my-flame          # Required: Cluster name (used for all resource naming)
  namespace: default      # Optional: Namespace (defaults to 'default')
  labels: {}             # Optional: Additional labels
  annotations: {}        # Optional: Additional annotations
```

The `metadata.name` is used as the base name for all created resources:
- Session Manager Pod: `<name>-session-manager`
- Executor Manager Pods: `<name>-executor-manager-<index>`
- Session Manager Service: `<name>-session-manager`
- Object Cache Service: `<name>-object-cache`
- ConfigMap: `<name>-config`

## Spec

### sessionManager

Configuration for the Session Manager component.

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `image` | string | **Yes** | - | Container image for Session Manager |
| `resources` | ResourceRequirements | No | `{}` | CPU/memory requests and limits |
| `slot` | string | No | `""` | Resource slot definition (e.g., "cpu=1,mem=1g") |
| `policy` | string | No | `""` | Scheduling policy (e.g., "priority", "fifo") |
| `storage` | string | No | `""` | Storage backend URI (e.g., "sqlite://flame.db") |

**Note:** The `endpoint` field is auto-generated by the operator based on the Service DNS name.


**Example:**

```yaml
spec:
  sessionManager:
    image: "xflops/flame-session:v0.1.0"
    resources:
      requests:
        cpu: "500m"
        memory: "512Mi"
      limits:
        cpu: "1"
        memory: "1Gi"
    slot: "cpu=1,mem=1g"
    policy: priority
    storage: sqlite://flame.db
```

### executorManager

Configuration for Executor Manager components.

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `image` | string | **Yes** | - | Container image for Executor Manager |
| `replicas` | int | No | `1` | Number of Executor Manager Pods |
| `resources` | ResourceRequirements | No | `{}` | CPU/memory requests and limits |
| `shim` | string | No | `""` | Executor shim type (e.g., "host") |
| `maxExecutors` | int | No | `0` | Maximum executor count per manager |

**Example:**

```yaml
spec:
  executorManager:
    image: "xflops/flame-executor:v0.1.0"
    replicas: 5
    resources:
      requests:
        cpu: "1"
        memory: "2Gi"
      limits:
        cpu: "2"
        memory: "4Gi"
    shim: host
    maxExecutors: 10
```

### objectCache

Configuration for the Object Cache service.

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `networkInterface` | string | No | `""` | Network interface for cache (e.g., "eth0") |
| `storage` | string | No | `""` | Cache storage path (e.g., "/var/lib/flame/cache") |

**Note:** The `endpoint` field is auto-generated by the operator based on the Service DNS name.

**Example:**

```yaml
spec:
  objectCache:
    networkInterface: "eth0"
    storage: "/var/lib/flame/cache"
```

## Status

The operator maintains status information about the cluster. Status fields are read-only and managed by the operator.

### sessionManager (status)

| Field | Type | Description |
|-------|------|-------------|
| `ready` | int | Number of ready Session Manager instances |
| `endpoint` | string | Auto-generated endpoint URL |

### executorManager (status)

| Field | Type | Description |
|-------|------|-------------|
| `replicas` | int | Desired executor count (from spec) |
| `ready` | int | Number of ready Executor Manager Pods |


### Cluster Status Fields

| Field | Type | Description |
|-------|------|-------------|
| `state` | string | Overall cluster state (see below) |
| `configGeneration` | int | Tracks configuration version for change detection |
| `message` | string | Human-readable status message |

**Cluster States:**

| State | Description |
|-------|-------------|
| `Pending` | Initial state, or Session Manager Pod not yet ready |
| `Running` | Session Manager ready AND at least one Executor ready |
| `Failed` | Session Manager Pod failed, or all Executor Pods failed |

**Example status:**

```yaml
status:
  sessionManager:
    ready: 1
    endpoint: "http://my-flame-session-manager:8080"
  executorManager:
    replicas: 3
    ready: 3
  state: "Running"
  configGeneration: 1
  message: "All components healthy"
```

## Auto-Generated Configuration

The operator automatically generates certain values:

| Generated Value | Format | Description |
|-----------------|--------|-------------|
| Session Manager endpoint | `http://<name>-session-manager:8080` | Service DNS for Session Manager |
| Object Cache endpoint | `grpc://<name>-object-cache:9090` | Service DNS for Object Cache |
| Cluster name | `<metadata.name>` | Derived from FlameCluster name |

These values are injected into the auto-generated ConfigMap and made available to all Pods.

## ConfigMap Generation

The operator generates a ConfigMap named `<name>-config` containing a `flame-cluster.yaml` file:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-flame-config
data:
  flame-cluster.yaml: |
    cluster:
      name: my-flame
      endpoint: "http://my-flame-session-manager:8080"
      slot: "cpu=1,mem=1g"
      policy: priority
      storage: sqlite://flame.db
    executors:
      shim: host
      limits:
        max_executors: 10
    cache:
      endpoint: "grpc://my-flame-object-cache:9090"
      network_interface: "eth0"
      storage: "/var/lib/flame/cache"
```

This ConfigMap is mounted at `/etc/flame` in all Pods.

## Service Discovery

The operator creates the following Services:

| Service | DNS Name | Port | Protocol |
|---------|----------|------|----------|
| Session Manager | `<name>-session-manager.<namespace>.svc.cluster.local` | 8080 | HTTP |
| Object Cache | `<name>-object-cache.<namespace>.svc.cluster.local` | 9090 | gRPC |

Environment variables injected into Pods:
- `SESSION_MANAGER_ADDR`: Session Manager Service DNS
- `OBJECT_CACHE_ADDR`: Object Cache Service DNS
- `FLAME_CONFIG`: Path to configuration file (`/etc/flame/flame-cluster.yaml`)

## Complete Example

```yaml
apiVersion: flame.xflops.io/v1alpha1
kind: FlameCluster
metadata:
  name: production-flame
  namespace: flame-production
spec:
  sessionManager:
    image: "xflops/flame-session:v0.1.0"
    resources:
      requests:
        cpu: "500m"
        memory: "512Mi"
      limits:
        cpu: "1"
        memory: "1Gi"
    slot: "cpu=2,mem=4g"
    policy: priority
    storage: sqlite://flame.db
  
  executorManager:
    image: "xflops/flame-executor:v0.1.0"
    replicas: 10
    resources:
      requests:
        cpu: "2"
        memory: "4Gi"
      limits:
        cpu: "4"
        memory: "8Gi"
    shim: host
    maxExecutors: 20
  
  objectCache:
    networkInterface: "eth0"
    storage: "/var/lib/flame/cache"
```
